import com.fasterxml.jackson.databind.ObjectMapper
import deployments.DockerRegistrySecret
import deployments.NotaryDeployment

import java.util.function.BiConsumer

/**
 * Creates deployment for K8s namespace isolation and ACR credentials for pulling docker images
 */
task buildNamespaceAndCreds(type: DeploymentTask) {
    def namespaceDep = kdeployment.buildNamespace(namespaceName)
    def acrCredentialsDep = new DockerRegistrySecret(
            namespaceName,
            ledgerRegCred,
            docker_push_registry,
            rootProject.ext.'docker.push.username',
            rootProject.ext.'docker.push.password'
    )
    deployments = [namespaceDep, acrCredentialsDep] as Iterable<Object>
    fileName = "namespaceAndCredDeployment"
}

/**
 * Creates a deployment for Auction Network
 * [Networks Services, Notary, Alice, Bob, Charlie]
 */
task buildAuctionNetwork(type: DeploymentTask, dependsOn: ['buildNamespaceAndCreds']) {
    def auctionNetworkServices = kdeployment.buildNMSDeployment.call(
            namespaceName,
            "auctionNMS",
            nmsImageName
    )
    def auctionNotaryDeployment = NotaryDeployment.buildNotaryDeployment(
            namespaceName as String,
            "auction-notary",
            "roastario/notary-one:2",
            auctionNetworkServices.getNmsService()
    )

    // Node deployment
    ObjectMapper mapper = new ObjectMapper()
    def nodesProperties = new Properties()
    file("$projectDir/azure/nodes.properties").withInputStream { nodesProperties.load(it) }
    List<Iterable<Object>> auctionNodeDeployments = new ArrayList()

    nodesProperties.forEach({identifier, nodeSerialized ->
        def node = mapper.readValue(nodeSerialized, Map.class)
        if ((node.get("networks") as List).contains("auction")) {
            println "Configuring ${node.toString()} for deployment."

            def currentNode = kdeployment.buildNodeDeployment.call(
                    ledgerRegCred,
                    namespaceName as String,
                    "auction-$identifier" as String,
                    node.get("x500") as String,
                    gallery_cordapp_docker_image_name as String,
                    "1"
            )
            auctionNodeDeployments.add(currentNode)
        }
    } as BiConsumer<String, String>)

    deployments = [auctionNetworkServices, auctionNotaryDeployment, *auctionNodeDeployments]
    fileName = "auctionNetworkDeployment"
}

/**
 * Creates a deployment for GBP Network
 * [Networks Services, Notary, Alice, Bob]
 */
task buildGbpNetwork(type: DeploymentTask, dependsOn: ['buildNamespaceAndCreds']) {
    def gbpNetworkServices = kdeployment.buildNMSDeployment.call(
            namespaceName,
            "gbpNMS",
            nmsImageName
    )
    def gbpNotaryDeployment = NotaryDeployment.buildNotaryDeployment(
            namespaceName as String,
            "gbp-notary",
            "roastario/notary-one:2",
            gbpNetworkServices.getNmsService()
    )

    // Node deployment
    ObjectMapper mapper = new ObjectMapper()
    def nodesProperties = new Properties()
    file("$projectDir/azure/nodes.properties").withInputStream { nodesProperties.load(it) }
    List<Iterable<Object>> gbpNodeDeployments = new ArrayList()

    nodesProperties.forEach({identifier, nodeSerialized ->
        def node = mapper.readValue(nodeSerialized, Map.class)
        if ((node.get("networks") as List).contains("gbp")) {
            println "Configuring ${node.toString()} for deployment."

            def currentNode = kdeployment.buildNodeDeployment.call(
                    ledgerRegCred,
                    namespaceName as String,
                    "gbp-$identifier",
                    node.get("x500") as String,
                    gallery_cordapp_docker_image_name as String,
                    "1"
            )
            gbpNodeDeployments.add(currentNode)
        }
    } as BiConsumer<String, String>)

    deployments = [gbpNetworkServices, gbpNotaryDeployment, *gbpNodeDeployments]
    fileName = "gbpNetworkDeployment"
}

/**
 * Creates a deployment for CBDC Network
 * [Networks Services, Notary, Alice, Charlie]
 */
task buildCbdcNetwork(type: DeploymentTask, dependsOn: ['buildNamespaceAndCreds']) {
    def cbdcNetworkServices = kdeployment.buildNMSDeployment.call(
            namespaceName,
            "cbdcNMS",
            nmsImageName
    )
    def cbdcNotaryDeployment = NotaryDeployment.buildNotaryDeployment(
            namespaceName as String,
            "auction-notary",
            "roastario/notary-one:2",
            cbdcNetworkServices.getNmsService()
    )

    // Node deployment
    ObjectMapper mapper = new ObjectMapper()
    def nodesProperties = new Properties()
    file("$projectDir/azure/nodes.properties").withInputStream { nodesProperties.load(it) }
    List<Iterable<Object>> cbdcNodeDeployments = new ArrayList()

    nodesProperties.forEach({identifier, nodeSerialized ->
        def node = mapper.readValue(nodeSerialized, Map.class)
        if ((node.get("networks") as List).contains("cbdc")) {
            println "Configuring ${node.toString()} for deployment."

            def currentNode = kdeployment.buildNodeDeployment.call(
                    ledgerRegCred,
                    namespaceName as String,
                    "cbdc-$identifier",
                    node.get("x500") as String,
                    gallery_cordapp_docker_image_name as String,
                    "1"
            )
            cbdcNodeDeployments.add(currentNode)
        }
    } as BiConsumer<String, String>)

    deployments = [cbdcNetworkServices, cbdcNotaryDeployment, *cbdcNodeDeployments]
    fileName = "cbdcNetworkDeployment"
}